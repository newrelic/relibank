apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: relibank-payment-resilience-test
  namespace: relibank
  labels:
    app: relibank
    experiment-type: comprehensive
spec:
  entry: payment-flow-chaos
  templates:
  - name: payment-flow-chaos
    templateType: Serial
    deadline: 10m
    children:
    - database-stress
    - network-chaos
    - pod-failures
    - recovery-validation

  # Step 1: Stress the PostgreSQL accounts database
  - name: database-stress
    templateType: StressChaos
    deadline: 2m
    stressChaos:
      selector:
        namespaces:
        - relibank
        labelSelectors:
          app: accounts-db
      mode: one
      duration: 90s
      stressors:
        cpu:
          workers: 2
          load: 80
        memory:
          workers: 1
          size: 512Mi

  # Step 2: Introduce network latency between services
  - name: network-chaos
    templateType: NetworkChaos
    deadline: 3m
    networkChaos:
      selector:
        namespaces:
        - relibank
        labelSelectors:
          app: transaction-service
      mode: one
      action: delay
      duration: 120s
      delay:
        latency: 500ms
        correlation: "25"
        jitter: 100ms
      target:
        selector:
          namespaces:
          - relibank
          labelSelectors:
            app: mssql
        mode: all

  # Step 3: Kill critical service pods randomly
  - name: pod-failures
    templateType: PodChaos
    deadline: 3m
    podChaos:
      selector:
        namespaces:
        - relibank
        labelSelectors:
          app: accounts-service
      mode: one
      action: pod-kill
      duration: 60s
      gracePeriod: 0

  # Step 4: Validate system recovery
  - name: recovery-validation
    templateType: PodChaos
    deadline: 2m
    podChaos:
      selector:
        namespaces:
        - relibank
        labelSelectors:
          app: bill-pay-service
      mode: one
      action: pod-failure
      duration: 30s
      gracePeriod: 5

---
apiVersion: chaos-mesh.org/v1alpha1
kind: Schedule
metadata:
  name: relibank-payment-resilience-schedule
  namespace: relibank
  labels:
    app: relibank
    experiment-type: scheduled
spec:
  schedule: "0 */6 * * *"  # Run every 6 hours
  type: Workflow
  workflowSpec:
    entry: payment-flow-chaos
    templates:
    - name: payment-flow-chaos
      templateType: Serial
      deadline: 10m
      children:
      - light-network-chaos
      - service-restart

    # Light network delay during scheduled runs
    - name: light-network-chaos
      templateType: NetworkChaos
      deadline: 2m
      networkChaos:
        selector:
          namespaces:
          - relibank
          labelSelectors:
            app: notifications-service
        mode: one
        action: delay
        duration: 60s
        delay:
          latency: 200ms
          correlation: "10"
          jitter: 50ms
        target:
          selector:
            namespaces:
            - relibank
            labelSelectors:
              app: kafka
          mode: all

    # Restart scheduler service periodically
    - name: service-restart
      templateType: PodChaos
      deadline: 2m
      podChaos:
        selector:
          namespaces:
          - relibank
          labelSelectors:
            app: scheduler-service
        mode: one
        action: pod-kill
        duration: 30s
        gracePeriod: 10
