apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-kafka-config
  namespace: relibank
data:
  config.yaml: |
    receivers:
      kafkametrics:
        brokers:
          - ${env:KAFKA_BROKER_ADDRESS}
        protocol_version: 2.8.0
        scrapers:
          - brokers
          - topics
          - consumers
        collection_interval: 30s
        topic_match: ".*"
        metrics:
          kafka.topic.min_insync_replicas:
            enabled: true
          kafka.topic.replication_factor:
            enabled: true
          kafka.partition.replicas:
            enabled: false
          kafka.partition.oldest_offset:
            enabled: false
          kafka.partition.current_offset:
            enabled: false

      jmx/kafka_broker-1:
        jar_path: /opt/opentelemetry-jmx-scraper.jar
        endpoint: ${env:KAFKA_BROKER_JMX_ADDRESS}
        target_system: kafka
        collection_interval: 30s
        resource_attributes:
          broker.id: "1"
          broker.endpoint: ${env:KAFKA_BROKER_JMX_ADDRESS}

    processors:
      batch/aggregation:
        send_batch_size: 1024
        timeout: 30s

      resourcedetection:
        detectors: [env, system]
        system:
          resource_attributes:
            host.name:
              enabled: true
            host.id:
              enabled: true

      resource:
        attributes:
          - action: insert
            key: kafka.cluster.name
            value: ${env:KAFKA_CLUSTER_NAME}

      transform/remove_broker_id:
        metric_statements:
          - context: resource
            statements:
              - delete_key(attributes, "broker.id")

      filter/include_cluster_metrics:
        metrics:
          include:
            match_type: regexp
            metric_names:
              - "kafka\\.partition\\.offline"
              - "kafka\\.(leader|unclean)\\.election\\.rate"
              - "kafka\\.partition\\.non_preferred_leader"
              - "kafka\\.broker\\.fenced\\.count"
              - "kafka\\.cluster\\.partition\\.count"
              - "kafka\\.cluster\\.topic\\.count"

      filter/exclude_cluster_metrics:
        metrics:
          exclude:
            match_type: regexp
            metric_names:
              - "kafka\\.partition\\.offline"
              - "kafka\\.(leader|unclean)\\.election\\.rate"
              - "kafka\\.partition\\.non_preferred_leader"
              - "kafka\\.broker\\.fenced\\.count"
              - "kafka\\.cluster\\.partition\\.count"
              - "kafka\\.cluster\\.topic\\.count"

      transform/des_units:
        metric_statements:
          - context: metric
            statements:
              - set(description, "") where description != ""
              - set(unit, "") where unit != ""

      cumulativetodelta: {}

      metricstransform/kafka_topic_sum_aggregation:
        transforms:
          - include: kafka.partition.replicas_in_sync
            action: insert
            new_name: kafka.partition.replicas_in_sync.total
            operations:
              - action: aggregate_labels
                label_set: [topic]
                aggregation_type: sum

      filter/remove_partition_level_replicas:
        metrics:
          exclude:
            match_type: strict
            metric_names:
              - kafka.partition.replicas_in_sync

    exporters:
      otlp/newrelic:
        endpoint: https://otlp.nr-data.net:4317
        headers:
          api-key: ${env:NEW_RELIC_LICENSE_KEY}
        tls:
          insecure: true  # Set to false for production; true for local testing without CA certs
        compression: gzip
        timeout: 30s

    service:
      pipelines:
        metrics/brokers-cluster-topics:
          receivers: [jmx/kafka_broker-1, kafkametrics]
          processors: [resourcedetection, resource, filter/exclude_cluster_metrics, transform/des_units, cumulativetodelta, metricstransform/kafka_topic_sum_aggregation, filter/remove_partition_level_replicas, batch/aggregation]
          exporters: [otlp/newrelic]

        metrics/jmx-cluster:
          receivers: [jmx/kafka_broker-1]
          processors: [resourcedetection, resource, filter/include_cluster_metrics, transform/remove_broker_id, transform/des_units, cumulativetodelta, batch/aggregation]
          exporters: [otlp/newrelic]
