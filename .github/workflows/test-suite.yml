name: Relibank Test Suite

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - e2e
          - scenario
          - payment
          - frontend
          - smoke

jobs:
  python-tests:
    runs-on: ubuntu-latest
    environment: events
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'e2e' || github.event.inputs.test_suite == 'scenario' || github.event.inputs.test_suite == 'payment' || github.event.inputs.test_suite == 'smoke' || github.event.inputs.test_suite == '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Reset chaos rate limit
        run: |
          echo "Resetting chaos rate limit before running tests..."
          curl -X POST "${{ vars.BASE_URL }}/scenario-runner/api/chaos-rate-limit-reset" || echo "Rate limit reset failed (may not be available)"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd tests
          pip install pytest requests pytest-xdist

      - name: Run all Python tests
        if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
        env:
          RELIBANK_URL: ${{ vars.BASE_URL }}
          BASE_URL: ${{ vars.BASE_URL }}
          ACCOUNTS_SERVICE: ${{ vars.BASE_URL }}
          AUTH_SERVICE: ${{ vars.BASE_URL }}
          BILL_PAY_SERVICE: ${{ vars.BASE_URL }}
          CHATBOT_SERVICE: ${{ vars.BASE_URL }}
          SCENARIO_SERVICE_URL: ${{ vars.BASE_URL }}/scenario-runner
        run: |
          cd tests
          pytest . -n auto -v --tb=short

      - name: Run end-to-end tests only
        if: ${{ github.event.inputs.test_suite == 'e2e' }}
        env:
          RELIBANK_URL: ${{ vars.BASE_URL }}
          BASE_URL: ${{ vars.BASE_URL }}
          ACCOUNTS_SERVICE: ${{ vars.BASE_URL }}
          AUTH_SERVICE: ${{ vars.BASE_URL }}
          BILL_PAY_SERVICE: ${{ vars.BASE_URL }}
          CHATBOT_SERVICE: ${{ vars.BASE_URL }}
          SCENARIO_SERVICE_URL: ${{ vars.BASE_URL }}/scenario-runner
        run: |
          cd tests
          pytest test_end_to_end.py -n auto -v --tb=short

      - name: Run scenario service tests only
        if: ${{ github.event.inputs.test_suite == 'scenario' }}
        env:
          RELIBANK_URL: ${{ vars.BASE_URL }}
          SCENARIO_SERVICE_URL: ${{ vars.BASE_URL }}/scenario-runner
        run: |
          cd tests
          pytest test_scenario_service.py -n auto -v --tb=short

      - name: Run payment scenario tests only
        if: ${{ github.event.inputs.test_suite == 'payment' }}
        env:
          RELIBANK_URL: ${{ vars.BASE_URL }}
          SCENARIO_SERVICE_URL: ${{ vars.BASE_URL }}/scenario-runner
          BILL_PAY_SERVICE: ${{ vars.BASE_URL }}
        run: |
          cd tests
          pytest test_payment_scenarios.py -n auto -v --tb=short

      - name: Run smoke tests only
        if: ${{ github.event.inputs.test_suite == 'smoke' }}
        env:
          RELIBANK_URL: ${{ vars.BASE_URL }}
          BASE_URL: ${{ vars.BASE_URL }}
          SCENARIO_SERVICE_URL: ${{ vars.BASE_URL }}/scenario-runner
        run: |
          cd tests
          pytest test_end_to_end.py::test_frontend_loads test_scenario_service.py::test_scenario_service_health -n auto -v --tb=short

  frontend-tests:
    runs-on: ubuntu-latest
    environment: events
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'frontend' || github.event.inputs.test_suite == '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend_service/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend_service
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend_service
          npm test

  test-summary:
    runs-on: ubuntu-latest
    needs: [python-tests, frontend-tests]
    if: always()

    steps:
      - name: Test Results Summary
        run: |
          echo "## Relibank Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Python Tests:** ${{ needs.python-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Tests:** ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** ${{ github.event.inputs.test_suite || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ vars.BASE_URL }}" >> $GITHUB_STEP_SUMMARY
